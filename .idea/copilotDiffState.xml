<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/example/notby/data/TokenManager.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/example/notby/data/TokenManager.java" />
              <option name="originalContent" value="package com.example.notby.data;&#10;&#10;import android.content.Context;&#10;import android.content.SharedPreferences;&#10;import android.util.Base64;&#10;import org.json.JSONObject;&#10;&#10;public class TokenManager {&#10;    private static final String PREF_NAME = &quot;NotByPrefs&quot;;&#10;    private static final String KEY_JWT_TOKEN = &quot;jwt_token&quot;;&#10;    private static final String KEY_USER_EMAIL = &quot;user_email&quot;;&#10;    private static final String KEY_USER_NAME = &quot;user_name&quot;;&#10;    private static final String KEY_USER_ID = &quot;user_id&quot;;&#10;&#10;    private SharedPreferences sharedPreferences;&#10;    private SharedPreferences.Editor editor;&#10;&#10;    public TokenManager(Context context) {&#10;        sharedPreferences = context.getSharedPreferences(PREF_NAME, Context.MODE_PRIVATE);&#10;        editor = sharedPreferences.edit();&#10;    }&#10;&#10;    public void saveToken(String token) {&#10;        editor.putString(KEY_JWT_TOKEN, token);&#10;        editor.apply();&#10;    }&#10;&#10;    public String getToken() {&#10;        return sharedPreferences.getString(KEY_JWT_TOKEN, null);&#10;    }&#10;&#10;    public void saveUserData(String userId, String email, String name) {&#10;        editor.putString(KEY_USER_ID, userId);&#10;        editor.putString(KEY_USER_EMAIL, email);&#10;        editor.putString(KEY_USER_NAME, name);&#10;        editor.apply();&#10;    }&#10;&#10;    public String getUserId() {&#10;        return sharedPreferences.getString(KEY_USER_ID, null);&#10;    }&#10;&#10;    public String getUserEmail() {&#10;        return sharedPreferences.getString(KEY_USER_EMAIL, null);&#10;    }&#10;&#10;    public String getUserName() {&#10;        return sharedPreferences.getString(KEY_USER_NAME, null);&#10;    }&#10;&#10;    public boolean isLoggedIn() {&#10;        return getToken() != null;&#10;    }&#10;&#10;    public void clearSession() {&#10;        editor.clear();&#10;        editor.apply();&#10;    }&#10;}" />
              <option name="updatedContent" value="package com.example.notby.data;&#10;&#10;import android.content.Context;&#10;import android.content.SharedPreferences;&#10;import android.util.Base64;&#10;import org.json.JSONObject;&#10;&#10;public class TokenManager {&#10;    private static final String PREF_NAME = &quot;NotByPrefs&quot;;&#10;    private static final String KEY_JWT_TOKEN = &quot;jwt_token&quot;;&#10;    private static final String KEY_USER_EMAIL = &quot;user_email&quot;;&#10;    private static final String KEY_USER_NAME = &quot;user_name&quot;;&#10;    private static final String KEY_USER_ID = &quot;user_id&quot;;&#10;    private static final String KEY_CHILD_ID = &quot;child_id&quot;;&#10;&#10;    private SharedPreferences sharedPreferences;&#10;    private SharedPreferences.Editor editor;&#10;&#10;    public TokenManager(Context context) {&#10;        sharedPreferences = context.getSharedPreferences(PREF_NAME, Context.MODE_PRIVATE);&#10;        editor = sharedPreferences.edit();&#10;    }&#10;&#10;    public void saveToken(String token) {&#10;        editor.putString(KEY_JWT_TOKEN, token);&#10;        editor.apply();&#10;    }&#10;&#10;    public String getToken() {&#10;        return sharedPreferences.getString(KEY_JWT_TOKEN, null);&#10;    }&#10;&#10;    public void saveUserData(String userId, String email, String name) {&#10;        editor.putString(KEY_USER_ID, userId);&#10;        editor.putString(KEY_USER_EMAIL, email);&#10;        editor.putString(KEY_USER_NAME, name);&#10;        editor.apply();&#10;    }&#10;&#10;    public String getUserId() {&#10;        return sharedPreferences.getString(KEY_USER_ID, null);&#10;    }&#10;&#10;    public String getUserEmail() {&#10;        return sharedPreferences.getString(KEY_USER_EMAIL, null);&#10;    }&#10;&#10;    public String getUserName() {&#10;        return sharedPreferences.getString(KEY_USER_NAME, null);&#10;    }&#10;&#10;    /**&#10;     * Extract user ID from JWT token&#10;     * @return user ID from token or null if extraction fails&#10;     */&#10;    public String getUserIdFromToken() {&#10;        String token = getToken();&#10;        if (token == null || token.isEmpty()) {&#10;            return null;&#10;        }&#10;        &#10;        try {&#10;            // JWT token has 3 parts separated by dots: header.payload.signature&#10;            String[] tokenParts = token.split(&quot;\\.&quot;);&#10;            if (tokenParts.length != 3) {&#10;                return null;&#10;            }&#10;            &#10;            // Decode the payload (second part)&#10;            String payload = tokenParts[1];&#10;            &#10;            // Add padding if needed for Base64 decoding&#10;            while (payload.length() % 4 != 0) {&#10;                payload += &quot;=&quot;;&#10;            }&#10;            &#10;            // Decode Base64&#10;            byte[] decodedBytes = Base64.decode(payload, Base64.URL_SAFE);&#10;            String decodedPayload = new String(decodedBytes);&#10;            &#10;            // Parse JSON&#10;            JSONObject payloadJson = new JSONObject(decodedPayload);&#10;            &#10;            // Try common user ID field names&#10;            String userId = null;&#10;            if (payloadJson.has(&quot;userId&quot;)) {&#10;                userId = payloadJson.getString(&quot;userId&quot;);&#10;            } else if (payloadJson.has(&quot;user_id&quot;)) {&#10;                userId = payloadJson.getString(&quot;user_id&quot;);&#10;            } else if (payloadJson.has(&quot;id&quot;)) {&#10;                userId = payloadJson.getString(&quot;id&quot;);&#10;            } else if (payloadJson.has(&quot;sub&quot;)) {&#10;                userId = payloadJson.getString(&quot;sub&quot;);&#10;            }&#10;            &#10;            return userId;&#10;            &#10;        } catch (Exception e) {&#10;            return null;&#10;        }&#10;    }&#10;&#10;    public void saveChildId(String childId) {&#10;        editor.putString(KEY_CHILD_ID, childId);&#10;        editor.apply();&#10;    }&#10;&#10;    public String getChildId() {&#10;        return sharedPreferences.getString(KEY_CHILD_ID, null);&#10;    }&#10;&#10;    public boolean isLoggedIn() {&#10;        return getToken() != null;&#10;    }&#10;&#10;    public void clearSession() {&#10;        editor.clear();&#10;        editor.apply();&#10;    }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/app/src/main/res/values/post_strings.xml">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/VIDEO_UPLOAD_IMPLEMENTATION.md" />
              <option name="updatedContent" value="# Video Upload Modal Implementation&#10;&#10;## Overview&#10;I've successfully implemented a video upload modal for the video screen (position 1) in the LibraryContentFragment. The implementation follows the specified workflow: Cloudinary API upload → MediaFile API creation.&#10;&#10;## Files Created/Modified&#10;&#10;### New Files Created:&#10;1. **`dialog_upload_video.xml`** - Modal layout with video selection, progress indicators, and upload controls&#10;2. **`VideoUploadManager.java`** - Handles the upload workflow (Cloudinary → MediaFile API)&#10;3. **`button_background.xml`** - Styled button background drawable&#10;4. **`ic_upload.xml`** - Upload icon for the FloatingActionButton&#10;&#10;### Modified Files:&#10;1. **`fragment_library_content.xml`** - Added FloatingActionButton for video upload&#10;2. **`LibraryContentFragment.java`** - Added upload functionality and modal handling&#10;3. **`AndroidManifest.xml`** - Added READ_EXTERNAL_STORAGE permission&#10;&#10;## Implementation Details&#10;&#10;### Video Upload Workflow:&#10;1. **File Selection**: User taps FAB → opens video picker → selects video file&#10;2. **Cloudinary Upload**: Selected video is uploaded to Cloudinary API&#10;3. **MediaFile Creation**: Using the Cloudinary response URL, creates MediaFile via MediaFile API&#10;4. **UI Update**: Refreshes video list to show the newly uploaded video&#10;&#10;### JSON Format Used:&#10;The MediaFile creation follows the specified format:&#10;```json&#10;{&#10;  &quot;fileUrl&quot;: &quot;string&quot;,     // From Cloudinary response&#10;  &quot;fileName&quot;: &quot;string&quot;,    // Original file name&#10;  &quot;fileType&quot;: &quot;video&quot;,     // Fixed value&#10;  &quot;Author&quot;: &quot;user_id&quot;      // From JWT token via TokenManager&#10;}&#10;```&#10;&#10;### Key Features:&#10;- **Visual Feedback**: Progress indicators and status messages during upload&#10;- **Error Handling**: Comprehensive error handling with user-friendly messages&#10;- **File Validation**: Ensures proper video file selection&#10;- **User Experience**: Modal-based upload with cancel functionality&#10;- **Integration**: Seamlessly integrates with existing video list display&#10;&#10;### Modal UI Components:&#10;- File selection button&#10;- Selected file display&#10;- Progress bar with status text&#10;- Upload and cancel buttons&#10;- Vietnamese language support&#10;&#10;### Technical Implementation:&#10;- **ActivityResultLauncher**: Modern Android file picker implementation&#10;- **Async Upload**: Non-blocking upload with callback-based progress updates&#10;- **JWT Integration**: Automatic user ID extraction from stored JWT token&#10;- **REST API Integration**: Proper error handling for both Cloudinary and MediaFile APIs&#10;&#10;## Usage&#10;1. Navigate to the Video tab (position 1)&#10;2. Tap the upload FAB (floating action button)&#10;3. Select a video file from device storage&#10;4. Tap &quot;Tải lên&quot; (Upload) to start the upload process&#10;5. Wait for completion - the video list will automatically refresh&#10;&#10;The implementation is now complete and ready for testing. The video upload modal will only appear in the video screen (position 1) and provides a seamless way for users to upload videos through the Cloudinary and MediaFile APIs as requested." />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/example/notby/data/model/Article.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/example/notby/data/model/Article.java" />
              <option name="originalContent" value="package com.example.notby.data.model;&#10;&#10;import com.google.gson.JsonElement;&#10;import com.google.gson.JsonObject;&#10;import com.google.gson.annotations.SerializedName;&#10;import java.util.List;&#10;&#10;public class Article {&#10;    @SerializedName(&quot;_id&quot;)&#10;    private String id;&#10;&#10;    @SerializedName(&quot;CategoryId&quot;)&#10;    private String categoryId;&#10;&#10;    @SerializedName(&quot;Title&quot;)&#10;    private String title;&#10;&#10;    @SerializedName(&quot;Content&quot;)&#10;    private String content;&#10;&#10;    @SerializedName(&quot;FileId&quot;)&#10;    private String fileId;&#10;&#10;    @SerializedName(&quot;Author&quot;)&#10;    private JsonElement author; // can be String, object, or null&#10;&#10;    @SerializedName(&quot;Description&quot;)&#10;    private String description;&#10;&#10;    @SerializedName(&quot;File&quot;)&#10;    private MediaFile file;&#10;&#10;    @SerializedName(&quot;Category&quot;)&#10;    private Category category;&#10;&#10;    @SerializedName(&quot;Likes&quot;)&#10;    private int likes;&#10;&#10;    @SerializedName(&quot;Views&quot;)&#10;    private int views;&#10;&#10;    @SerializedName(&quot;Tags&quot;)&#10;    private List&lt;String&gt; tags;&#10;&#10;    @SerializedName(&quot;ReadTime&quot;)&#10;    private int readTime;&#10;&#10;    @SerializedName(&quot;created_at&quot;)&#10;    private String createdAt;&#10;&#10;    @SerializedName(&quot;updated_at&quot;)&#10;    private String updatedAt;&#10;&#10;    // Getters&#10;    public String getId() { return id; }&#10;    public String getCategoryId() { return categoryId; }&#10;    public String getTitle() { return title; }&#10;    public String getContent() { return content; }&#10;    public String getFileId() { return fileId; }&#10;    public String getAuthorId() {&#10;        if (author == null || author.isJsonNull()) return null;&#10;        if (author.isJsonPrimitive()) {&#10;            try { return author.getAsString(); } catch (Exception e) { return null; }&#10;        }&#10;        if (author.isJsonObject()) {&#10;            JsonObject obj = author.getAsJsonObject();&#10;            if (obj.has(&quot;_id&quot;) &amp;&amp; !obj.get(&quot;_id&quot;).isJsonNull()) return obj.get(&quot;_id&quot;).getAsString();&#10;            if (obj.has(&quot;id&quot;) &amp;&amp; !obj.get(&quot;id&quot;).isJsonNull()) return obj.get(&quot;id&quot;).getAsString();&#10;        }&#10;        return null;&#10;    }&#10;    public String getDescription() { return description; }&#10;    public MediaFile getFile() { return file; }&#10;    public Category getCategory() { return category; }&#10;    public int getLikes() { return likes; }&#10;    public int getViews() { return views; }&#10;    public List&lt;String&gt; getTags() { return tags; }&#10;    public int getReadTime() { return readTime; }&#10;    public String getCreatedAt() { return createdAt; }&#10;    public String getUpdatedAt() { return updatedAt; }&#10;    public JsonElement getAuthor() { return author; }&#10;&#10;    // Setters&#10;    public void setId(String id) { this.id = id; }&#10;    public void setCategoryId(String categoryId) { this.categoryId = categoryId; }&#10;    public void setTitle(String title) { this.title = title; }&#10;    public void setContent(String content) { this.content = content; }&#10;    public void setFileId(String fileId) { this.fileId = fileId; }&#10;    public void setAuthor(JsonElement author) { this.author = author; }&#10;    public void setDescription(String description) { this.description = description; }&#10;    public void setFile(MediaFile file) { this.file = file; }&#10;    public void setCategory(Category category) { this.category = category; }&#10;    public void setLikes(int likes) { this.likes = likes; }&#10;    public void setViews(int views) { this.views = views; }&#10;    public void setTags(List&lt;String&gt; tags) { this.tags = tags; }&#10;    public void setReadTime(int readTime) { this.readTime = readTime; }&#10;    public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }&#10;    public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }&#10;&#10;    // Get image URL helper method&#10;    public String getImageUrl() {&#10;        return file != null ? file.getFileUrl() : null;&#10;    }&#10;}&#10;" />
              <option name="updatedContent" value="package com.example.notby.data.model;&#10;&#10;import com.google.gson.JsonElement;&#10;import com.google.gson.JsonObject;&#10;import com.google.gson.annotations.SerializedName;&#10;import java.util.List;&#10;&#10;public class Article {&#10;    @SerializedName(&quot;_id&quot;)&#10;    private String id;&#10;&#10;    @SerializedName(&quot;CategoryId&quot;)&#10;    private String categoryId;&#10;&#10;    @SerializedName(&quot;Title&quot;)&#10;    private String title;&#10;&#10;    @SerializedName(&quot;Content&quot;)&#10;    private String content;&#10;&#10;    @SerializedName(&quot;FileId&quot;)&#10;    private String fileId;&#10;&#10;    @SerializedName(&quot;Author&quot;)&#10;    private JsonElement author; // can be String, object, or null&#10;&#10;    @SerializedName(&quot;Description&quot;)&#10;    private String description;&#10;&#10;    @SerializedName(&quot;File&quot;)&#10;    private MediaFile file;&#10;&#10;    @SerializedName(&quot;Category&quot;)&#10;    private Category category;&#10;&#10;    @SerializedName(&quot;Likes&quot;)&#10;    private int likes;&#10;&#10;    @SerializedName(&quot;Views&quot;)&#10;    private int views;&#10;&#10;    @SerializedName(&quot;Tags&quot;)&#10;    private List&lt;String&gt; tags;&#10;&#10;    @SerializedName(&quot;ReadTime&quot;)&#10;    private int readTime;&#10;&#10;    @SerializedName(&quot;created_at&quot;)&#10;    private String createdAt;&#10;&#10;    @SerializedName(&quot;updated_at&quot;)&#10;    private String updatedAt;&#10;&#10;    // Getters&#10;    public String getId() { return id; }&#10;    public String getCategoryId() { return categoryId; }&#10;    public String getTitle() { return title; }&#10;    public String getContent() { return content; }&#10;    public String getFileId() { return fileId; }&#10;    public String getAuthorId() {&#10;        if (author == null || author.isJsonNull()) return null;&#10;        if (author.isJsonPrimitive()) {&#10;            try { return author.getAsString(); } catch (Exception e) { return null; }&#10;        }&#10;        if (author.isJsonObject()) {&#10;            JsonObject obj = author.getAsJsonObject();&#10;            if (obj.has(&quot;_id&quot;) &amp;&amp; !obj.get(&quot;_id&quot;).isJsonNull()) return obj.get(&quot;_id&quot;).getAsString();&#10;            if (obj.has(&quot;id&quot;) &amp;&amp; !obj.get(&quot;id&quot;).isJsonNull()) return obj.get(&quot;id&quot;).getAsString();&#10;        }&#10;        return null;&#10;    }&#10;    public String getDescription() { return description; }&#10;    public MediaFile getFile() { return file; }&#10;    public Category getCategory() { return category; }&#10;    public int getLikes() { return likes; }&#10;    public int getViews() { return views; }&#10;    public List&lt;String&gt; getTags() { return tags; }&#10;    public int getReadTime() { return readTime; }&#10;    public String getCreatedAt() { return createdAt; }&#10;    public String getUpdatedAt() { return updatedAt; }&#10;    public JsonElement getAuthor() { return author; }&#10;&#10;    // Setters&#10;    public void setId(String id) { this.id = id; }&#10;    public void setCategoryId(String categoryId) { this.categoryId = categoryId; }&#10;    public void setTitle(String title) { this.title = title; }&#10;    public void setContent(String content) { this.content = content; }&#10;    public void setFileId(String fileId) { this.fileId = fileId; }&#10;    public void setAuthor(JsonElement author) { this.author = author; }&#10;    public void setDescription(String description) { this.description = description; }&#10;    public void setFile(MediaFile file) { this.file = file; }&#10;    public void setCategory(Category category) { this.category = category; }&#10;    public void setLikes(int likes) { this.likes = likes; }&#10;    public void setViews(int views) { this.views = views; }&#10;    public void setTags(List&lt;String&gt; tags) { this.tags = tags; }&#10;    public void setReadTime(int readTime) { this.readTime = readTime; }&#10;    public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }&#10;    public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }&#10;&#10;    // Get image URL helper method&#10;    public String getImageUrl() {&#10;        return file != null ? file.getFileUrl() : null;&#10;    }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/example/notby/ui/forumpost/ForumPostActivity.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/example/notby/ui/forumpost/ForumPostActivity.java" />
              <option name="originalContent" value="package com.example.notby.ui.forumpost;&#10;&#10;import android.content.Intent;&#10;import android.net.Uri;&#10;import android.os.Bundle;&#10;import android.util.Log;&#10;// Import cần thiết cho Menu&#10;import android.view.Menu;&#10;import android.view.MenuInflater;&#10;import android.view.MenuItem;&#10;import android.view.View;&#10;import android.widget.Button;&#10;import android.widget.EditText;&#10;import android.widget.Toast;&#10;import androidx.annotation.NonNull;&#10;import androidx.annotation.Nullable;&#10;import androidx.appcompat.app.AppCompatActivity;&#10;import androidx.appcompat.widget.Toolbar;&#10;import androidx.recyclerview.widget.LinearLayoutManager;&#10;import androidx.recyclerview.widget.RecyclerView;&#10;&#10;import com.example.notby.R;&#10;import com.example.notby.data.TokenManager;&#10;import com.example.notby.data.model.ApiResponse;&#10;import com.example.notby.data.model.ForumPost;&#10;import com.example.notby.data.model.MediaFile;&#10;import com.example.notby.data.remote.ApiClient;&#10;import com.example.notby.ui.dashboard.DashboardActivity;&#10;import com.example.notby.ui.library.LibraryActivity;&#10;&#10;&#10;import java.io.File;&#10;import java.io.FileOutputStream;&#10;import java.io.IOException;&#10;import java.io.InputStream;&#10;import java.io.OutputStream;&#10;import java.util.ArrayList;&#10;import java.util.List;&#10;import java.util.Map;&#10;&#10;import okhttp3.MediaType;&#10;import okhttp3.MultipartBody;&#10;import okhttp3.RequestBody;&#10;import retrofit2.Call;&#10;import retrofit2.Callback;&#10;import retrofit2.Response;&#10;&#10;public class ForumPostActivity extends AppCompatActivity {&#10;&#10;    private static final String TAG = &quot;ForumPostActivity&quot;;&#10;    private static final int REQUEST_PICK_FILE = 1001;&#10;&#10;    private RecyclerView recyclerView;&#10;    private ForumPostAdapter adapter;&#10;&#10;    // New UI elements&#10;    private EditText newPostTitle;&#10;    private EditText newPostContent;&#10;    private Button attachImageButton;&#10;    private Button postButton;&#10;&#10;    private Uri selectedFileUri = null;&#10;    private TokenManager tokenManager;&#10;&#10;    @Override&#10;    protected void onCreate(Bundle savedInstanceState) {&#10;        super.onCreate(savedInstanceState);&#10;        setContentView(R.layout.activity_forum_post);&#10;&#10;        // Setup toolbar with back button&#10;        Toolbar toolbar = findViewById(R.id.toolbar);&#10;        setSupportActionBar(toolbar);&#10;        if (getSupportActionBar() != null) {&#10;            getSupportActionBar().setTitle(&quot;Diễn đàn&quot;);&#10;            getSupportActionBar().setDisplayHomeAsUpEnabled(true);&#10;        }&#10;&#10;        // Initialize TokenManager&#10;        tokenManager = new TokenManager(this);&#10;&#10;        recyclerView = findViewById(R.id.recyclerView);&#10;        recyclerView.setLayoutManager(new LinearLayoutManager(this));&#10;&#10;        adapter = new ForumPostAdapter(new ArrayList&lt;&gt;());&#10;        recyclerView.setAdapter(adapter);&#10;&#10;        // wire new UI&#10;        newPostTitle = findViewById(R.id.newPostTitle);&#10;        newPostContent = findViewById(R.id.newPostContent);&#10;        attachImageButton = findViewById(R.id.attachImageButton);&#10;        postButton = findViewById(R.id.postButton);&#10;&#10;        attachImageButton.setOnClickListener(v -&gt; pickFile());&#10;        postButton.setOnClickListener(v -&gt; handlePostSubmit());&#10;&#10;        loadForumPosts();&#10;    }&#10;&#10;    // ===================================================================&#10;    // BƯỚC 1: NẠP FILE MENU VÀO TOOLBAR (PHẦN BẠN BỊ THIẾU)&#10;    // ===================================================================&#10;    @Override&#10;    public boolean onCreateOptionsMenu(Menu menu) {&#10;        getMenuInflater().inflate(R.menu.forum_toolbar_menu, menu);&#10;        return true;&#10;    }&#10;&#10;    // ===================================================================&#10;    // BƯỚC 2: XỬ LÝ KHI CLICK VÀO TỪNG MỤC MENU (PHẦN BẠN ĐÃ CÓ)&#10;    // ===================================================================&#10;    // Trong file ForumPostActivity.java&#10;&#10;    @Override&#10;    public boolean onOptionsItemSelected(@NonNull MenuItem item) {&#10;        int itemId = item.getItemId();&#10;&#10;        if (itemId == android.R.id.home) {&#10;            // Handle the back button&#10;            onBackPressed();&#10;            return true;&#10;        } else if (itemId == R.id.action_dashboard) {&#10;            // Navigate to Dashboard&#10;            Intent dashboardIntent = new Intent(this, DashboardActivity.class);&#10;            dashboardIntent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP); // Clear the activity stack&#10;            startActivity(dashboardIntent);&#10;            finish(); // Close this activity&#10;            return true;&#10;        } else if (itemId == R.id.action_library) {&#10;            // Navigate to Library&#10;            Intent libraryIntent = new Intent(this, LibraryActivity.class);&#10;            startActivity(libraryIntent);&#10;            return true;&#10;        } else if (itemId == R.id.action_development_diary) {&#10;            // Navigate to Dashboard with diary fragment&#10;            Intent dashboardIntent = new Intent(this, DashboardActivity.class);&#10;            dashboardIntent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP);&#10;            dashboardIntent.putExtra(&quot;open_diary&quot;, true);&#10;            startActivity(dashboardIntent);&#10;            finish();&#10;            return true;&#10;        }&#10;&#10;        return super.onOptionsItemSelected(item);&#10;    }&#10;&#10;    // ===================================================================&#10;    // CÁC HÀM CÒN LẠI CỦA BẠN (GIỮ NGUYÊN)&#10;    // ===================================================================&#10;&#10;    private void pickFile() {&#10;        Intent intent = new Intent(Intent.ACTION_GET_CONTENT);&#10;        intent.setType(&quot;*/*&quot;);&#10;        intent.addCategory(Intent.CATEGORY_OPENABLE);&#10;        startActivityForResult(Intent.createChooser(intent, &quot;Select file&quot;), REQUEST_PICK_FILE);&#10;    }&#10;&#10;    @Override&#10;    protected void onActivityResult(int requestCode, int resultCode, @Nullable Intent data) {&#10;        super.onActivityResult(requestCode, resultCode, data);&#10;        if (requestCode == REQUEST_PICK_FILE &amp;&amp; resultCode == RESULT_OK &amp;&amp; data != null) {&#10;            selectedFileUri = data.getData();&#10;            if (selectedFileUri != null) {&#10;                attachImageButton.setText(&quot;File selected&quot;);&#10;                Toast.makeText(this, &quot;File selected&quot;, Toast.LENGTH_SHORT).show();&#10;            }&#10;        }&#10;    }&#10;&#10;    private void handlePostSubmit() {&#10;        final String title = newPostTitle.getText() != null ? newPostTitle.getText().toString().trim() : &quot;&quot;;&#10;        final String content = newPostContent.getText() != null ? newPostContent.getText().toString().trim() : &quot;&quot;;&#10;&#10;        if (title.isEmpty() || content.isEmpty()) {&#10;            Toast.makeText(this, &quot;Tiêu đề và nội dung không được để trống&quot;, Toast.LENGTH_SHORT).show();&#10;            return;&#10;        }&#10;&#10;        postButton.setEnabled(false);&#10;        postButton.setText(&quot;Đang đăng...&quot;);&#10;&#10;        if (selectedFileUri != null) {&#10;            try {&#10;                final File uploadFile = createFileFromUri(selectedFileUri);&#10;                final String mimeTemp = getContentResolver().getType(selectedFileUri);&#10;                final String mime = mimeTemp == null ? &quot;application/octet-stream&quot; : mimeTemp;&#10;&#10;                RequestBody reqFile = RequestBody.create(MediaType.parse(mime), uploadFile);&#10;                MultipartBody.Part body = MultipartBody.Part.createFormData(&quot;file&quot;, uploadFile.getName(), reqFile);&#10;&#10;                ApiClient.getCloudinaryApi().uploadFile(body).enqueue(new Callback&lt;ApiResponse&lt;Object&gt;&gt;() {&#10;                    @Override&#10;                    public void onResponse(Call&lt;ApiResponse&lt;Object&gt;&gt; call, Response&lt;ApiResponse&lt;Object&gt;&gt; response) {&#10;                        if (response.isSuccessful() &amp;&amp; response.body() != null &amp;&amp; response.body().isStatus()) {&#10;                            Object data = response.body().getData();&#10;                            String fileUrl = extractFileUrlFromData(data);&#10;                            if (fileUrl == null) {&#10;                                deleteTempFile(uploadFile);&#10;                                onFailure(call, new Throwable(&quot;Unable to extract file URL from cloudinary response&quot;));&#10;                                return;&#10;                            }&#10;&#10;                            MediaFile mf = new MediaFile();&#10;                            mf.setFileUrl(fileUrl);&#10;                            mf.setFileName(uploadFile.getName());&#10;                            mf.setFileType(determineFileType(mime));&#10;                            mf.setAuthor(getAuthorId());&#10;&#10;                            ApiClient.getMediafileApi().create(mf).enqueue(new Callback&lt;ApiResponse&lt;MediaFile&gt;&gt;() {&#10;                                @Override&#10;                                public void onResponse(Call&lt;ApiResponse&lt;MediaFile&gt;&gt; call2, Response&lt;ApiResponse&lt;MediaFile&gt;&gt; resp2) {&#10;                                    deleteTempFile(uploadFile);&#10;                                    if (resp2.isSuccessful() &amp;&amp; resp2.body() != null &amp;&amp; resp2.body().isStatus()) {&#10;                                        MediaFile created = resp2.body().getData();&#10;                                        createForumPostAfterFile(title, content, created);&#10;                                    } else {&#10;                                        Toast.makeText(ForumPostActivity.this, &quot;Failed to create media file&quot;, Toast.LENGTH_SHORT).show();&#10;                                        resetPostButton();&#10;                                    }&#10;                                }&#10;&#10;                                @Override&#10;                                public void onFailure(Call&lt;ApiResponse&lt;MediaFile&gt;&gt; call2, Throwable t2) {&#10;                                    deleteTempFile(uploadFile);&#10;                                    Toast.makeText(ForumPostActivity.this, &quot;Media file creation failed: &quot; + t2.getMessage(), Toast.LENGTH_SHORT).show();&#10;                                    resetPostButton();&#10;                                }&#10;                            });&#10;&#10;                        } else {&#10;                            deleteTempFile(uploadFile);&#10;                            Toast.makeText(ForumPostActivity.this, &quot;Cloud upload failed: &quot; + response.message(), Toast.LENGTH_SHORT).show();&#10;                            resetPostButton();&#10;                        }&#10;                    }&#10;&#10;                    @Override&#10;                    public void onFailure(Call&lt;ApiResponse&lt;Object&gt;&gt; call, Throwable t) {&#10;                        deleteTempFile(uploadFile);&#10;                        Toast.makeText(ForumPostActivity.this, &quot;Upload failed: &quot; + t.getMessage(), Toast.LENGTH_SHORT).show();&#10;                        resetPostButton();&#10;                    }&#10;                });&#10;&#10;            } catch (IOException e) {&#10;                Toast.makeText(this, &quot;File error: &quot; + e.getMessage(), Toast.LENGTH_SHORT).show();&#10;                resetPostButton();&#10;            }&#10;        } else {&#10;            createForumPostAfterFile(title, content, null);&#10;        }&#10;    }&#10;&#10;    private void deleteTempFile(File file) {&#10;        if (file == null) return;&#10;        try {&#10;            if (file.exists()) {&#10;                if (!file.delete()) {&#10;                    file.deleteOnExit();&#10;                }&#10;            }&#10;        } catch (Exception e) {&#10;            e.printStackTrace();&#10;        }&#10;    }&#10;&#10;    private void createForumPostAfterFile(String title, String content, MediaFile file) {&#10;        String authorId = getAuthorId();&#10;        if (authorId == null || authorId.isEmpty()) {&#10;            Toast.makeText(this, &quot;Please log in to create a post&quot;, Toast.LENGTH_SHORT).show();&#10;            resetPostButton();&#10;            return;&#10;        }&#10;&#10;        ForumPost post = new ForumPost(title, content, authorId);&#10;        if (file != null) {&#10;            post.setFileId(file.getId()); // Set only the file ID for API request&#10;        }&#10;&#10;        ApiClient.getForumPostApi().create(post).enqueue(new Callback&lt;ApiResponse&lt;ForumPost&gt;&gt;() {&#10;            @Override&#10;            public void onResponse(Call&lt;ApiResponse&lt;ForumPost&gt;&gt; call, Response&lt;ApiResponse&lt;ForumPost&gt;&gt; response) {&#10;                if (response.isSuccessful() &amp;&amp; response.body() != null &amp;&amp; response.body().isStatus()) {&#10;                    newPostTitle.setText(&quot;&quot;);&#10;                    newPostContent.setText(&quot;&quot;);&#10;                    selectedFileUri = null;&#10;                    attachImageButton.setText(&quot;Ảnh&quot;);&#10;                    loadForumPosts();&#10;                    Toast.makeText(ForumPostActivity.this, &quot;Đăng bài thành công&quot;, Toast.LENGTH_SHORT).show();&#10;                } else {&#10;                    Toast.makeText(ForumPostActivity.this, &quot;Post creation failed: &quot; + response.message(), Toast.LENGTH_SHORT).show();&#10;                }&#10;                resetPostButton();&#10;            }&#10;&#10;            @Override&#10;            public void onFailure(Call&lt;ApiResponse&lt;ForumPost&gt;&gt; call, Throwable t) {&#10;                Toast.makeText(ForumPostActivity.this, &quot;Post creation failed: &quot; + t.getMessage(), Toast.LENGTH_SHORT).show();&#10;                resetPostButton();&#10;            }&#10;        });&#10;    }&#10;&#10;    private void resetPostButton() {&#10;        postButton.setEnabled(true);&#10;        postButton.setText(&quot;Đăng bài&quot;);&#10;    }&#10;&#10;    private String extractFileUrlFromData(Object data) {&#10;        if (data == null) return null;&#10;        if (data instanceof String) return (String) data;&#10;        if (data instanceof Map) {&#10;            Map&lt;?, ?&gt; map = (Map&lt;?, ?&gt;) data;&#10;            if (map.containsKey(&quot;url&quot;)) return String.valueOf(map.get(&quot;url&quot;));&#10;            if (map.containsKey(&quot;secure_url&quot;)) return String.valueOf(map.get(&quot;secure_url&quot;));&#10;            if (map.containsKey(&quot;data&quot;)) {&#10;                Object inner = map.get(&quot;data&quot;);&#10;                if (inner instanceof String) return (String) inner;&#10;                if (inner instanceof Map) {&#10;                    Map&lt;?, ?&gt; innerMap = (Map&lt;?, ?&gt;) inner;&#10;                    if (innerMap.containsKey(&quot;url&quot;)) return String.valueOf(innerMap.get(&quot;url&quot;));&#10;                }&#10;            }&#10;        }&#10;        return null;&#10;    }&#10;&#10;    private String determineFileType(String mime) {&#10;        if (mime == null) return &quot;other&quot;;&#10;        if (mime.startsWith(&quot;image/&quot;)) return &quot;image&quot;;&#10;        if (mime.startsWith(&quot;video/&quot;)) return &quot;video&quot;;&#10;        return &quot;other&quot;;&#10;    }&#10;&#10;    private String getAuthorId() {&#10;        String userId = tokenManager.getUserId();&#10;        if (userId == null || userId.isEmpty()) {&#10;            return null;&#10;        }&#10;        return userId;&#10;    }&#10;&#10;    private File createFileFromUri(Uri uri) throws IOException {&#10;        InputStream is = getContentResolver().openInputStream(uri);&#10;        if (is == null) throw new IOException(&quot;Unable to open input stream&quot;);&#10;        String fileName = &quot;upload&quot;;&#10;        String[] parts = uri.getLastPathSegment() != null ? uri.getLastPathSegment().split(&quot;/&quot;) : null;&#10;        if (parts != null &amp;&amp; parts.length &gt; 0) fileName = parts[parts.length - 1];&#10;&#10;        File temp = File.createTempFile(&quot;upload_&quot;, fileName, getCacheDir());&#10;        OutputStream os = new FileOutputStream(temp);&#10;        byte[] buffer = new byte[8192];&#10;        int len;&#10;        while ((len = is.read(buffer)) &gt; 0) {&#10;            os.write(buffer, 0, len);&#10;        }&#10;        os.flush();&#10;        os.close();&#10;        is.close();&#10;        return temp;&#10;    }&#10;&#10;    private void loadForumPosts() {&#10;        ApiClient.getForumPostApi().getAll().enqueue(new Callback&lt;ApiResponse&lt;List&lt;ForumPost&gt;&gt;&gt;() {&#10;            @Override&#10;            public void onResponse(Call&lt;ApiResponse&lt;List&lt;ForumPost&gt;&gt;&gt; call, Response&lt;ApiResponse&lt;List&lt;ForumPost&gt;&gt;&gt; response) {&#10;                if (response.isSuccessful() &amp;&amp; response.body() != null) {&#10;                    ApiResponse&lt;List&lt;ForumPost&gt;&gt; apiResponse = response.body();&#10;                    if (apiResponse.getData() != null) {&#10;                        adapter.updatePosts(apiResponse.getData());&#10;                    } else {&#10;                        Toast.makeText(ForumPostActivity.this,&#10;                                &quot;No posts available&quot;,&#10;                                Toast.LENGTH_SHORT).show();&#10;                    }&#10;                } else {&#10;                    Toast.makeText(ForumPostActivity.this,&#10;                            &quot;Error loading posts: &quot; + response.message(),&#10;                            Toast.LENGTH_SHORT).show();&#10;                }&#10;            }&#10;&#10;            @Override&#10;            public void onFailure(Call&lt;ApiResponse&lt;List&lt;ForumPost&gt;&gt;&gt; call, Throwable t) {&#10;                Toast.makeText(ForumPostActivity.this,&#10;                        &quot;Network error: &quot; + t.getMessage(),&#10;                        Toast.LENGTH_SHORT).show();&#10;            }&#10;        });&#10;    }&#10;&#10;    @Override&#10;    public boolean onSupportNavigateUp() {&#10;        onBackPressed();&#10;        return true;&#10;    }&#10;}&#10;" />
              <option name="updatedContent" value="package com.example.notby.ui.forumpost;&#10;&#10;import android.content.Intent;&#10;import android.net.Uri;&#10;import android.os.Bundle;&#10;import android.util.Log;&#10;// Import cần thiết cho Menu&#10;import android.view.Menu;&#10;import android.view.MenuInflater;&#10;import android.view.MenuItem;&#10;import android.view.View;&#10;import android.widget.Button;&#10;import android.widget.EditText;&#10;import android.widget.Toast;&#10;import androidx.annotation.NonNull;&#10;import androidx.annotation.Nullable;&#10;import androidx.appcompat.app.AppCompatActivity;&#10;import androidx.appcompat.widget.Toolbar;&#10;import androidx.recyclerview.widget.LinearLayoutManager;&#10;import androidx.recyclerview.widget.RecyclerView;&#10;&#10;import com.example.notby.R;&#10;import com.example.notby.data.TokenManager;&#10;import com.example.notby.data.model.ApiResponse;&#10;import com.example.notby.data.model.ForumPost;&#10;import com.example.notby.data.model.MediaFile;&#10;import com.example.notby.data.remote.ApiClient;&#10;import com.example.notby.ui.dashboard.DashboardActivity;&#10;import com.example.notby.ui.library.LibraryActivity;&#10;&#10;&#10;import java.io.File;&#10;import java.io.FileOutputStream;&#10;import java.io.IOException;&#10;import java.io.InputStream;&#10;import java.io.OutputStream;&#10;import java.util.ArrayList;&#10;import java.util.List;&#10;import java.util.Map;&#10;&#10;import okhttp3.MediaType;&#10;import okhttp3.MultipartBody;&#10;import okhttp3.RequestBody;&#10;import retrofit2.Call;&#10;import retrofit2.Callback;&#10;import retrofit2.Response;&#10;&#10;public class ForumPostActivity extends AppCompatActivity {&#10;&#10;    private static final String TAG = &quot;ForumPostActivity&quot;;&#10;    private static final int REQUEST_PICK_FILE = 1001;&#10;&#10;    private RecyclerView recyclerView;&#10;    private ForumPostAdapter adapter;&#10;&#10;    // New UI elements&#10;    private EditText newPostTitle;&#10;    private EditText newPostContent;&#10;    private Button attachImageButton;&#10;    private Button postButton;&#10;&#10;    private Uri selectedFileUri = null;&#10;    private TokenManager tokenManager;&#10;&#10;    @Override&#10;    protected void onCreate(Bundle savedInstanceState) {&#10;        super.onCreate(savedInstanceState);&#10;        setContentView(R.layout.activity_forum_post);&#10;&#10;        // Setup toolbar with back button&#10;        Toolbar toolbar = findViewById(R.id.toolbar);&#10;        setSupportActionBar(toolbar);&#10;        if (getSupportActionBar() != null) {&#10;            getSupportActionBar().setTitle(&quot;Diễn đàn&quot;);&#10;            getSupportActionBar().setDisplayHomeAsUpEnabled(true);&#10;        }&#10;&#10;        // Initialize TokenManager&#10;        tokenManager = new TokenManager(this);&#10;&#10;        recyclerView = findViewById(R.id.recyclerView);&#10;        recyclerView.setLayoutManager(new LinearLayoutManager(this));&#10;&#10;        adapter = new ForumPostAdapter(new ArrayList&lt;&gt;());&#10;        recyclerView.setAdapter(adapter);&#10;&#10;        // wire new UI&#10;        newPostTitle = findViewById(R.id.newPostTitle);&#10;        newPostContent = findViewById(R.id.newPostContent);&#10;        attachImageButton = findViewById(R.id.attachImageButton);&#10;        postButton = findViewById(R.id.postButton);&#10;&#10;        attachImageButton.setOnClickListener(v -&gt; pickFile());&#10;        postButton.setOnClickListener(v -&gt; handlePostSubmit());&#10;&#10;        loadForumPosts();&#10;    }&#10;&#10;    // ===================================================================&#10;    // BƯỚC 1: NẠP FILE MENU VÀO TOOLBAR (PHẦN BẠN BỊ THIẾU)&#10;    // ===================================================================&#10;    @Override&#10;    public boolean onCreateOptionsMenu(Menu menu) {&#10;        getMenuInflater().inflate(R.menu.forum_toolbar_menu, menu);&#10;        return true;&#10;    }&#10;&#10;    // ===================================================================&#10;    // BƯỚC 2: XỬ LÝ KHI CLICK VÀO TỪNG MỤC MENU (PHẦN BẠN ĐÃ CÓ)&#10;    // ===================================================================&#10;    // Trong file ForumPostActivity.java&#10;&#10;    @Override&#10;    public boolean onOptionsItemSelected(@NonNull MenuItem item) {&#10;        int itemId = item.getItemId();&#10;&#10;        if (itemId == android.R.id.home) {&#10;            // Handle the back button&#10;            onBackPressed();&#10;            return true;&#10;        } else if (itemId == R.id.action_dashboard) {&#10;            // Navigate to Dashboard&#10;            Intent dashboardIntent = new Intent(this, DashboardActivity.class);&#10;            dashboardIntent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP); // Clear the activity stack&#10;            startActivity(dashboardIntent);&#10;            finish(); // Close this activity&#10;            return true;&#10;        } else if (itemId == R.id.action_library) {&#10;            // Navigate to Library&#10;            Intent libraryIntent = new Intent(this, LibraryActivity.class);&#10;            startActivity(libraryIntent);&#10;            return true;&#10;        } else if (itemId == R.id.action_development_diary) {&#10;            // Navigate to Dashboard with diary fragment&#10;            Intent dashboardIntent = new Intent(this, DashboardActivity.class);&#10;            dashboardIntent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP);&#10;            dashboardIntent.putExtra(&quot;open_diary&quot;, true);&#10;            startActivity(dashboardIntent);&#10;            finish();&#10;            return true;&#10;        }&#10;&#10;        return super.onOptionsItemSelected(item);&#10;    }&#10;&#10;    // ===================================================================&#10;    // CÁC HÀM CÒN LẠI CỦA BẠN (GIỮ NGUYÊN)&#10;    // ===================================================================&#10;&#10;    private void pickFile() {&#10;        Intent intent = new Intent(Intent.ACTION_GET_CONTENT);&#10;        intent.setType(&quot;*/*&quot;);&#10;        intent.addCategory(Intent.CATEGORY_OPENABLE);&#10;        startActivityForResult(Intent.createChooser(intent, &quot;Select file&quot;), REQUEST_PICK_FILE);&#10;    }&#10;&#10;    @Override&#10;    protected void onActivityResult(int requestCode, int resultCode, @Nullable Intent data) {&#10;        super.onActivityResult(requestCode, resultCode, data);&#10;        if (requestCode == REQUEST_PICK_FILE &amp;&amp; resultCode == RESULT_OK &amp;&amp; data != null) {&#10;            selectedFileUri = data.getData();&#10;            if (selectedFileUri != null) {&#10;                attachImageButton.setText(&quot;File selected&quot;);&#10;                Toast.makeText(this, &quot;File selected&quot;, Toast.LENGTH_SHORT).show();&#10;            }&#10;        }&#10;    }&#10;&#10;    private void handlePostSubmit() {&#10;        final String title = newPostTitle.getText() != null ? newPostTitle.getText().toString().trim() : &quot;&quot;;&#10;        final String content = newPostContent.getText() != null ? newPostContent.getText().toString().trim() : &quot;&quot;;&#10;&#10;        if (title.isEmpty() || content.isEmpty()) {&#10;            Toast.makeText(this, &quot;Tiêu đề và nội dung không được để trống&quot;, Toast.LENGTH_SHORT).show();&#10;            return;&#10;        }&#10;&#10;        postButton.setEnabled(false);&#10;        postButton.setText(&quot;Đang đăng...&quot;);&#10;&#10;        if (selectedFileUri != null) {&#10;            try {&#10;                final File uploadFile = createFileFromUri(selectedFileUri);&#10;                final String mimeTemp = getContentResolver().getType(selectedFileUri);&#10;                final String mime = mimeTemp == null ? &quot;application/octet-stream&quot; : mimeTemp;&#10;&#10;                RequestBody reqFile = RequestBody.create(MediaType.parse(mime), uploadFile);&#10;                MultipartBody.Part body = MultipartBody.Part.createFormData(&quot;file&quot;, uploadFile.getName(), reqFile);&#10;&#10;                ApiClient.getCloudinaryApi().uploadFile(body).enqueue(new Callback&lt;ApiResponse&lt;Object&gt;&gt;() {&#10;                    @Override&#10;                    public void onResponse(Call&lt;ApiResponse&lt;Object&gt;&gt; call, Response&lt;ApiResponse&lt;Object&gt;&gt; response) {&#10;                        if (response.isSuccessful() &amp;&amp; response.body() != null &amp;&amp; response.body().isStatus()) {&#10;                            Object data = response.body().getData();&#10;                            String fileUrl = extractFileUrlFromData(data);&#10;                            if (fileUrl == null) {&#10;                                deleteTempFile(uploadFile);&#10;                                onFailure(call, new Throwable(&quot;Unable to extract file URL from cloudinary response&quot;));&#10;                                return;&#10;                            }&#10;&#10;                            MediaFile mf = new MediaFile();&#10;                            mf.setFileUrl(fileUrl);&#10;                            mf.setFileName(uploadFile.getName());&#10;                            mf.setFileType(determineFileType(mime));&#10;                            mf.setAuthor(getAuthorId());&#10;&#10;                            ApiClient.getMediafileApi().create(mf).enqueue(new Callback&lt;ApiResponse&lt;MediaFile&gt;&gt;() {&#10;                                @Override&#10;                                public void onResponse(Call&lt;ApiResponse&lt;MediaFile&gt;&gt; call2, Response&lt;ApiResponse&lt;MediaFile&gt;&gt; resp2) {&#10;                                    deleteTempFile(uploadFile);&#10;                                    if (resp2.isSuccessful() &amp;&amp; resp2.body() != null &amp;&amp; resp2.body().isStatus()) {&#10;                                        MediaFile created = resp2.body().getData();&#10;                                        createForumPostAfterFile(title, content, created);&#10;                                    } else {&#10;                                        Toast.makeText(ForumPostActivity.this, &quot;Failed to create media file&quot;, Toast.LENGTH_SHORT).show();&#10;                                        resetPostButton();&#10;                                    }&#10;                                }&#10;&#10;                                @Override&#10;                                public void onFailure(Call&lt;ApiResponse&lt;MediaFile&gt;&gt; call2, Throwable t2) {&#10;                                    deleteTempFile(uploadFile);&#10;                                    Toast.makeText(ForumPostActivity.this, &quot;Media file creation failed: &quot; + t2.getMessage(), Toast.LENGTH_SHORT).show();&#10;                                    resetPostButton();&#10;                                }&#10;                            });&#10;&#10;                        } else {&#10;                            deleteTempFile(uploadFile);&#10;                            Toast.makeText(ForumPostActivity.this, &quot;Cloud upload failed: &quot; + response.message(), Toast.LENGTH_SHORT).show();&#10;                            resetPostButton();&#10;                        }&#10;                    }&#10;&#10;                    @Override&#10;                    public void onFailure(Call&lt;ApiResponse&lt;Object&gt;&gt; call, Throwable t) {&#10;                        deleteTempFile(uploadFile);&#10;                        Toast.makeText(ForumPostActivity.this, &quot;Upload failed: &quot; + t.getMessage(), Toast.LENGTH_SHORT).show();&#10;                        resetPostButton();&#10;                    }&#10;                });&#10;&#10;            } catch (IOException e) {&#10;                Toast.makeText(this, &quot;File error: &quot; + e.getMessage(), Toast.LENGTH_SHORT).show();&#10;                resetPostButton();&#10;            }&#10;        } else {&#10;            createForumPostAfterFile(title, content, null);&#10;        }&#10;    }&#10;&#10;    private void deleteTempFile(File file) {&#10;        if (file == null) return;&#10;        try {&#10;            if (file.exists()) {&#10;                if (!file.delete()) {&#10;                    file.deleteOnExit();&#10;                }&#10;            }&#10;        } catch (Exception e) {&#10;            e.printStackTrace();&#10;        }&#10;    }&#10;&#10;    private void createForumPostAfterFile(String title, String content, MediaFile file) {&#10;        String authorId = getAuthorId();&#10;        if (authorId == null || authorId.isEmpty()) {&#10;            Toast.makeText(this, &quot;Please log in to create a post&quot;, Toast.LENGTH_SHORT).show();&#10;            resetPostButton();&#10;            return;&#10;        }&#10;&#10;        ForumPost post = new ForumPost(title, content, authorId);&#10;        if (file != null) {&#10;            post.setFileId(file.getId()); // Set only the file ID for API request&#10;        }&#10;&#10;        ApiClient.getForumPostApi().create(post).enqueue(new Callback&lt;ApiResponse&lt;ForumPost&gt;&gt;() {&#10;            @Override&#10;            public void onResponse(Call&lt;ApiResponse&lt;ForumPost&gt;&gt; call, Response&lt;ApiResponse&lt;ForumPost&gt;&gt; response) {&#10;                if (response.isSuccessful() &amp;&amp; response.body() != null &amp;&amp; response.body().isStatus()) {&#10;                    newPostTitle.setText(&quot;&quot;);&#10;                    newPostContent.setText(&quot;&quot;);&#10;                    selectedFileUri = null;&#10;                    attachImageButton.setText(&quot;Ảnh&quot;);&#10;                    loadForumPosts();&#10;                    Toast.makeText(ForumPostActivity.this, &quot;Đăng bài thành công&quot;, Toast.LENGTH_SHORT).show();&#10;                } else {&#10;                    Toast.makeText(ForumPostActivity.this, &quot;Post creation failed: &quot; + response.message(), Toast.LENGTH_SHORT).show();&#10;                }&#10;                resetPostButton();&#10;            }&#10;&#10;            @Override&#10;            public void onFailure(Call&lt;ApiResponse&lt;ForumPost&gt;&gt; call, Throwable t) {&#10;                Toast.makeText(ForumPostActivity.this, &quot;Post creation failed: &quot; + t.getMessage(), Toast.LENGTH_SHORT).show();&#10;                resetPostButton();&#10;            }&#10;        });&#10;    }&#10;&#10;    private void resetPostButton() {&#10;        postButton.setEnabled(true);&#10;        postButton.setText(&quot;Đăng bài&quot;);&#10;    }&#10;&#10;    private String extractFileUrlFromData(Object data) {&#10;        if (data == null) return null;&#10;        if (data instanceof String) return (String) data;&#10;        if (data instanceof Map) {&#10;            Map&lt;?, ?&gt; map = (Map&lt;?, ?&gt;) data;&#10;            if (map.containsKey(&quot;url&quot;)) return String.valueOf(map.get(&quot;url&quot;));&#10;            if (map.containsKey(&quot;secure_url&quot;)) return String.valueOf(map.get(&quot;secure_url&quot;));&#10;            if (map.containsKey(&quot;data&quot;)) {&#10;                Object inner = map.get(&quot;data&quot;);&#10;                if (inner instanceof String) return (String) inner;&#10;                if (inner instanceof Map) {&#10;                    Map&lt;?, ?&gt; innerMap = (Map&lt;?, ?&gt;) inner;&#10;                    if (innerMap.containsKey(&quot;url&quot;)) return String.valueOf(innerMap.get(&quot;url&quot;));&#10;                }&#10;            }&#10;        }&#10;        return null;&#10;    }&#10;&#10;    private String determineFileType(String mime) {&#10;        if (mime == null) return &quot;other&quot;;&#10;        if (mime.startsWith(&quot;image/&quot;)) return &quot;image&quot;;&#10;        if (mime.startsWith(&quot;video/&quot;)) return &quot;video&quot;;&#10;        return &quot;other&quot;;&#10;    }&#10;&#10;    private String getAuthorId() {&#10;        String userId = tokenManager.getUserId();&#10;        if (userId == null || userId.isEmpty()) {&#10;            return null;&#10;        }&#10;        return userId;&#10;    }&#10;&#10;    private File createFileFromUri(Uri uri) throws IOException {&#10;        InputStream is = getContentResolver().openInputStream(uri);&#10;        if (is == null) throw new IOException(&quot;Unable to open input stream&quot;);&#10;        String fileName = &quot;upload&quot;;&#10;        String[] parts = uri.getLastPathSegment() != null ? uri.getLastPathSegment().split(&quot;/&quot;) : null;&#10;        if (parts != null &amp;&amp; parts.length &gt; 0) fileName = parts[parts.length - 1];&#10;&#10;        File temp = File.createTempFile(&quot;upload_&quot;, fileName, getCacheDir());&#10;        OutputStream os = new FileOutputStream(temp);&#10;        byte[] buffer = new byte[8192];&#10;        int len;&#10;        while ((len = is.read(buffer)) &gt; 0) {&#10;            os.write(buffer, 0, len);&#10;        }&#10;        os.flush();&#10;        os.close();&#10;        is.close();&#10;        return temp;&#10;    }&#10;&#10;    private void loadForumPosts() {&#10;        ApiClient.getForumPostApi().getAll().enqueue(new Callback&lt;ApiResponse&lt;List&lt;ForumPost&gt;&gt;&gt;() {&#10;            @Override&#10;            public void onResponse(Call&lt;ApiResponse&lt;List&lt;ForumPost&gt;&gt;&gt; call, Response&lt;ApiResponse&lt;List&lt;ForumPost&gt;&gt;&gt; response) {&#10;                if (response.isSuccessful() &amp;&amp; response.body() != null) {&#10;                    ApiResponse&lt;List&lt;ForumPost&gt;&gt; apiResponse = response.body();&#10;                    if (apiResponse.getData() != null) {&#10;                        adapter.updatePosts(apiResponse.getData());&#10;                    } else {&#10;                        Toast.makeText(ForumPostActivity.this,&#10;                                &quot;No posts available&quot;,&#10;                                Toast.LENGTH_SHORT).show();&#10;                    }&#10;                } else {&#10;                    Toast.makeText(ForumPostActivity.this,&#10;                            &quot;Error loading posts: &quot; + response.message(),&#10;                            Toast.LENGTH_SHORT).show();&#10;                }&#10;            }&#10;&#10;            @Override&#10;            public void onFailure(Call&lt;ApiResponse&lt;List&lt;ForumPost&gt;&gt;&gt; call, Throwable t) {&#10;                Toast.makeText(ForumPostActivity.this,&#10;                        &quot;Network error: &quot; + t.getMessage(),&#10;                        Toast.LENGTH_SHORT).show();&#10;            }&#10;        });&#10;    }&#10;&#10;    @Override&#10;    public boolean onSupportNavigateUp() {&#10;        onBackPressed();&#10;        return true;&#10;    }&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>